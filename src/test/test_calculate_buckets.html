<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculate Buckets Test - UOB PPV and UOB VS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .pass {
            color: #4CAF50;
            font-weight: bold;
        }
        .fail {
            color: #f44336;
            font-weight: bold;
        }
        h2 {
            color: #333;
        }
        .instructions {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üß™ Calculate Buckets Test Page</h1>
    
    <div class="instructions">
        <h3>üìã Instructions:</h3>
        <ol>
            <li>Open the browser console (F12 or Ctrl+Shift+I)</li>
            <li>Click the test buttons below</li>
            <li>Verify that all tests pass</li>
        </ol>
    </div>

    <div class="section">
        <h2>UOB PPV Tests</h2>
        <button onclick="testUobPpvContactless()">Test UOB PPV Contactless</button>
        <button onclick="testUobPpvOnline()">Test UOB PPV Online</button>
        <button onclick="testUobPpvMixed()">Test UOB PPV Mixed</button>
        <div id="ppv-results" class="result"></div>
    </div>

    <div class="section">
        <h2>UOB VS Tests</h2>
        <button onclick="testUobVsContactless()">Test UOB VS Contactless</button>
        <button onclick="testUobVsForeignCurrency()">Test UOB VS Foreign Currency</button>
        <button onclick="testUobVsMixed()">Test UOB VS Mixed</button>
        <div id="vs-results" class="result"></div>
    </div>

    <div class="section">
        <h2>Blacklist Tests</h2>
        <button onclick="testBlacklistMcc()">Test Blacklist MCC</button>
        <button onclick="testBlacklistMerchant()">Test Blacklist Merchant</button>
        <div id="blacklist-results" class="result"></div>
    </div>

    <script>
        // Inline the calculateBuckets function for testing
        function calculateBuckets(apiResponse, cardShortName = 'UOB PPV') {
            // Define the ppv_online_mcc list directly in the function
            const ppvShoppingMcc = [4816, 5262, 5306, 5309, 5310, 5311, 5331, 5399, 5611, 5621, 5631, 5641, 5651, 5661, 5691, 5699, 5732, 5733, 5734, 5735, 5912, 5942, 5944, 5945, 5946, 5947, 5948, 5949, 5964, 5965, 5966, 5967, 5968, 5969, 5970, 5992, 5999];
            const ppvDiningMcc = [5811, 5812, 5814, 5333, 5411, 5441, 5462, 5499, 8012, 9751];
            const ppvEntertainmentMcc = [7278, 7832, 7841, 7922, 7991, 7996, 7998, 7999];
            
            // Blacklist MCC codes - transactions with these codes should not be counted
            const blacklistMcc = [4829, 4900, 5199, 5960, 5965, 5993, 6012, 6050, 6051, 6211, 6300, 6513, 6529, 6530, 6534, 6540, 7349, 7511, 7523, 7995, 8062, 8211, 8220, 8241, 8244, 8249, 8299, 8398, 8661, 8651, 8699, 8999, 9211, 9222, 9223, 9311, 9402, 9405, 9399];
            
            // Blacklist merchant name prefixes - transactions starting with these should not be counted
            const blacklistMerchantPrefixes = [
                "AXS", "AMAZE", "AMAZE* TRANSIT", "BANC DE BINARY", "BANCDEBINARY.COM",
                "EZ LINK PTE LTD (FEVO)", "EZ Link transport", "EZ Link", "EZ-LINK (IMAGINE CARD)",
                "EZ-Link EZ-Reload (ATU)", "EZLINK", "EzLink", "EZ-LINK", "FlashPay ATU",
                "MB * MONEYBOOKERS.COM", "NETS VCASHCARD", "OANDA ASIA PAC", "OANDAASIAPA",
                "PAYPAL * BIZCONSULTA", "PAYPAL * CAPITALROYA", "PAYPAL * OANDAASIAPA",
                "Saxo Cap Mkts Pte Ltd", "SKR*SKRILL.COM", "SKR*xglobalmarkets.com", "SKYFX.COM",
                "TRANSIT", "WWW.IGMARKETS.COM.SG", "IPAYMY", "RWS-LEVY", "SMOOVE PAY",
                "SINGPOST-SAM", "RazerPay", "NORWDS"
            ];
            
            // Helper function to round down to the nearest $5
            const roundDownToNearestFive = (amount) => Math.floor(amount / 5) * 5;
            
            // Helper function to check if transaction is blacklisted
            const isBlacklisted = (transaction) => {
                // Check MCC code blacklist
                const mccCode = parseInt(transaction.mcc_code, 10);
                if (blacklistMcc.includes(mccCode)) {
                    return true;
                }
                
                // Check merchant name blacklist
                if (transaction.merchant_name) {
                    for (const prefix of blacklistMerchantPrefixes) {
                        if (transaction.merchant_name.startsWith(prefix)) {
                            return true;
                        }
                    }
                }
                
                return false;
            };

            let contactlessBucket = 0;
            let onlineBucket = 0;
            let foreignCurrencyBucket = 0;

            if (cardShortName === 'UOB VS') {
                // UOB Visa Signature logic
                // Foreign currency transactions take priority over contactless
                apiResponse.forEach((transactionObj) => {
                    const transaction = transactionObj.transaction;
                    
                    // Skip blacklisted transactions
                    if (isBlacklisted(transaction)) {
                        return;
                    }

                    if (transaction.original_currency && transaction.original_currency !== 'SGD') {
                        // Round down and add to foreign currency bucket
                        foreignCurrencyBucket += roundDownToNearestFive(transaction.base_currency_amount);
                    } else if (transaction.payment_tag === 'contactless') {
                        // Only count in contactless if NOT foreign currency
                        contactlessBucket += roundDownToNearestFive(transaction.base_currency_amount);
                    }
                });

                return { contactless: contactlessBucket, foreignCurrency: foreignCurrencyBucket };
            } else {
                // UOB PPV logic (default)
                apiResponse.forEach((transactionObj) => {
                    const transaction = transactionObj.transaction;
                    
                    // Skip blacklisted transactions
                    if (isBlacklisted(transaction)) {
                        return;
                    }

                    if (transaction.payment_tag === 'contactless') {
                        // Round down and add to contactless bucket
                        contactlessBucket += roundDownToNearestFive(transaction.base_currency_amount);
                    } else if (transaction.payment_tag === 'online') {
                        // Check if mcc_code is in ppv_online_mcc
                        const mccCode = parseInt(transaction.mcc_code, 10); // Ensure mcc_code is an integer
                        if (ppvShoppingMcc.includes(mccCode) || ppvDiningMcc.includes(mccCode) || ppvEntertainmentMcc.includes(mccCode)) {
                            // Round down and add to online bucket
                            onlineBucket += roundDownToNearestFive(transaction.base_currency_amount);
                        }
                    }
                });

                return { contactless: contactlessBucket, online: onlineBucket };
            }
        }
    </script>
    <script>
        function displayResult(elementId, testName, passed, expected, actual) {
            const element = document.getElementById(elementId);
            const status = passed ? '<span class="pass">‚úÖ PASS</span>' : '<span class="fail">‚ùå FAIL</span>';
            const message = `${status} - ${testName}<br>Expected: ${JSON.stringify(expected)}<br>Actual: ${JSON.stringify(actual)}`;
            element.innerHTML += message + '<hr>';
            console.log(`[Test] ${testName}: ${passed ? 'PASS' : 'FAIL'}`, { expected, actual });
        }

        function testUobPpvContactless() {
            const ppvResults = document.getElementById('ppv-results');
            ppvResults.innerHTML = '<strong>Running UOB PPV Contactless Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 27.50, mcc_code: '5411' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 43.20, mcc_code: '5811' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 12.80, mcc_code: '5999' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            const expected = { contactless: 75, online: 0 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('ppv-results', 'UOB PPV Contactless Bucket', passed, expected, result);
        }

        function testUobPpvOnline() {
            const ppvResults = document.getElementById('ppv-results');
            ppvResults.innerHTML += '<strong>Running UOB PPV Online Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'online', base_currency_amount: 52.30, mcc_code: '5611' } }, // Shopping MCC
                { transaction: { payment_tag: 'online', base_currency_amount: 38.90, mcc_code: '5811' } }, // Dining MCC
                { transaction: { payment_tag: 'online', base_currency_amount: 25.60, mcc_code: '7999' } }, // Entertainment MCC
                { transaction: { payment_tag: 'online', base_currency_amount: 19.40, mcc_code: '9999' } }  // Not in eligible MCC list
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            // 50 + 35 + 25 = 110 (19.40 with MCC 9999 is not eligible)
            const expected = { contactless: 0, online: 110 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('ppv-results', 'UOB PPV Online Bucket', passed, expected, result);
        }

        function testUobPpvMixed() {
            const ppvResults = document.getElementById('ppv-results');
            ppvResults.innerHTML += '<strong>Running UOB PPV Mixed Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 33.70, mcc_code: '5411' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 47.20, mcc_code: '5812' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 18.50, mcc_code: '5999' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 62.80, mcc_code: '5621' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            // Contactless: 30 + 15 = 45
            // Online: 45 + 60 = 105
            const expected = { contactless: 45, online: 105 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('ppv-results', 'UOB PPV Mixed Buckets', passed, expected, result);
        }

        function testUobVsContactless() {
            const vsResults = document.getElementById('vs-results');
            vsResults.innerHTML = '<strong>Running UOB VS Contactless Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 27.50, original_currency: 'SGD' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 43.20, original_currency: 'SGD' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 12.80, original_currency: 'SGD' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB VS');
            // Contactless: 25 + 40 + 10 = 75
            // Foreign: 0 (all SGD)
            const expected = { contactless: 75, foreignCurrency: 0 };
            const passed = result.contactless === expected.contactless && result.foreignCurrency === expected.foreignCurrency;
            
            displayResult('vs-results', 'UOB VS Contactless Bucket', passed, expected, result);
        }

        function testUobVsForeignCurrency() {
            const vsResults = document.getElementById('vs-results');
            vsResults.innerHTML += '<strong>Running UOB VS Foreign Currency Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'online', base_currency_amount: 52.30, original_currency: 'USD' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 38.90, original_currency: 'EUR' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 25.60, original_currency: 'GBP' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 19.40, original_currency: 'SGD' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB VS');
            // Contactless: 0 (no contactless)
            // Foreign: 50 + 35 + 25 = 110 (SGD transaction not counted)
            const expected = { contactless: 0, foreignCurrency: 110 };
            const passed = result.contactless === expected.contactless && result.foreignCurrency === expected.foreignCurrency;
            
            displayResult('vs-results', 'UOB VS Foreign Currency Bucket', passed, expected, result);
        }

        function testUobVsMixed() {
            const vsResults = document.getElementById('vs-results');
            vsResults.innerHTML += '<strong>Running UOB VS Mixed Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 33.70, original_currency: 'SGD' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 47.20, original_currency: 'USD' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 18.50, original_currency: 'EUR' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 62.80, original_currency: 'SGD' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB VS');
            // Contactless: 30 (only SGD contactless, EUR contactless goes to foreign)
            // Foreign: 45 + 15 = 60 (USD online + EUR contactless)
            const expected = { contactless: 30, foreignCurrency: 60 };
            const passed = result.contactless === expected.contactless && result.foreignCurrency === expected.foreignCurrency;
            
            displayResult('vs-results', 'UOB VS Mixed Buckets', passed, expected, result);
        }

        function testBlacklistMcc() {
            const blacklistResults = document.getElementById('blacklist-results');
            blacklistResults.innerHTML = '<strong>Running Blacklist MCC Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 50.00, mcc_code: '5411' } }, // Valid
                { transaction: { payment_tag: 'contactless', base_currency_amount: 30.00, mcc_code: '4829' } }, // Blacklisted MCC
                { transaction: { payment_tag: 'contactless', base_currency_amount: 40.00, mcc_code: '5811' } }, // Valid
                { transaction: { payment_tag: 'contactless', base_currency_amount: 25.00, mcc_code: '6012' } }  // Blacklisted MCC
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            // Only valid transactions: 50 + 40 = 90
            const expected = { contactless: 90, online: 0 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('blacklist-results', 'Blacklist MCC Code', passed, expected, result);
        }

        function testBlacklistMerchant() {
            const blacklistResults = document.getElementById('blacklist-results');
            blacklistResults.innerHTML += '<strong>Running Blacklist Merchant Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 50.00, mcc_code: '5411', merchant_name: 'Regular Store' } }, // Valid
                { transaction: { payment_tag: 'contactless', base_currency_amount: 30.00, mcc_code: '5811', merchant_name: 'EZ-LINK Top Up' } }, // Blacklisted merchant
                { transaction: { payment_tag: 'contactless', base_currency_amount: 40.00, mcc_code: '5999', merchant_name: 'Another Store' } }, // Valid
                { transaction: { payment_tag: 'contactless', base_currency_amount: 25.00, mcc_code: '5621', merchant_name: 'IPAYMY Payment' } }  // Blacklisted merchant
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            // Only valid transactions: 50 + 40 = 90
            const expected = { contactless: 90, online: 0 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('blacklist-results', 'Blacklist Merchant Name', passed, expected, result);
        }

        // Initial message
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Test Page] Calculate Buckets test page loaded');
            console.log('[Test Page] Click test buttons to run tests');
        });
    </script>
</body>
</html>
