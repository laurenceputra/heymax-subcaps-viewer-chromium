<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculate Buckets Test - UOB PPV and UOB VS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .pass {
            color: #4CAF50;
            font-weight: bold;
        }
        .fail {
            color: #f44336;
            font-weight: bold;
        }
        h2 {
            color: #333;
        }
        .instructions {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üß™ Calculate Buckets Test Page</h1>
    
    <div class="instructions">
        <h3>üìã Instructions:</h3>
        <ol>
            <li>Open the browser console (F12 or Ctrl+Shift+I)</li>
            <li>Click the test buttons below</li>
            <li>Verify that all tests pass</li>
        </ol>
    </div>

    <div class="section">
        <h2>UOB PPV Tests</h2>
        <button onclick="testUobPpvContactless()">Test UOB PPV Contactless</button>
        <button onclick="testUobPpvOnline()">Test UOB PPV Online</button>
        <button onclick="testUobPpvMixed()">Test UOB PPV Mixed</button>
        <div id="ppv-results" class="result"></div>
    </div>

    <div class="section">
        <h2>UOB VS Tests</h2>
        <button onclick="testUobVsContactless()">Test UOB VS Contactless</button>
        <button onclick="testUobVsForeignCurrency()">Test UOB VS Foreign Currency</button>
        <button onclick="testUobVsMixed()">Test UOB VS Mixed</button>
        <div id="vs-results" class="result"></div>
    </div>

    <script>
        // Inline the calculateBuckets function for testing
        function calculateBuckets(apiResponse, cardShortName = 'UOB PPV') {
            // Define the ppv_online_mcc list directly in the function
            const ppvShoppingMcc = [4816, 5262, 5306, 5309, 5310, 5311, 5331, 5399, 5611, 5621, 5631, 5641, 5651, 5661, 5691, 5699, 5732, 5733, 5734, 5735, 5912, 5942, 5944, 5945, 5946, 5947, 5948, 5949, 5964, 5965, 5966, 5967, 5968, 5969, 5970, 5992, 5999];
            const ppvDiningMcc = [5811, 5812, 5814, 5333, 5411, 5441, 5462, 5499, 8012, 9751];
            const ppvEntertainmentMcc = [7278, 7832, 7841, 7922, 7991, 7996, 7998, 7999];
            // Helper function to round down to the nearest $5
            const roundDownToNearestFive = (amount) => Math.floor(amount / 5) * 5;

            let contactlessBucket = 0;
            let onlineBucket = 0;
            let foreignCurrencyBucket = 0;

            if (cardShortName === 'UOB VS') {
                // UOB Visa Signature logic
                apiResponse.forEach((transactionObj) => {
                    const transaction = transactionObj.transaction;

                    if (transaction.payment_tag === 'contactless') {
                        // Round down and add to contactless bucket
                        contactlessBucket += roundDownToNearestFive(transaction.base_currency_amount);
                    }
                    
                    if (transaction.original_currency && transaction.original_currency !== 'SGD') {
                        // Round down and add to foreign currency bucket
                        foreignCurrencyBucket += roundDownToNearestFive(transaction.base_currency_amount);
                    }
                });

                return { contactless: contactlessBucket, foreignCurrency: foreignCurrencyBucket };
            } else {
                // UOB PPV logic (default)
                apiResponse.forEach((transactionObj) => {
                    const transaction = transactionObj.transaction;

                    if (transaction.payment_tag === 'contactless') {
                        // Round down and add to contactless bucket
                        contactlessBucket += roundDownToNearestFive(transaction.base_currency_amount);
                    } else if (transaction.payment_tag === 'online') {
                        // Check if mcc_code is in ppv_online_mcc
                        const mccCode = parseInt(transaction.mcc_code, 10); // Ensure mcc_code is an integer
                        if (ppvShoppingMcc.includes(mccCode) || ppvDiningMcc.includes(mccCode) || ppvEntertainmentMcc.includes(mccCode)) {
                            // Round down and add to online bucket
                            onlineBucket += roundDownToNearestFive(transaction.base_currency_amount);
                        }
                    }
                });

                return { contactless: contactlessBucket, online: onlineBucket };
            }
        }
    </script>
    <script>
        function displayResult(elementId, testName, passed, expected, actual) {
            const element = document.getElementById(elementId);
            const status = passed ? '<span class="pass">‚úÖ PASS</span>' : '<span class="fail">‚ùå FAIL</span>';
            const message = `${status} - ${testName}<br>Expected: ${JSON.stringify(expected)}<br>Actual: ${JSON.stringify(actual)}`;
            element.innerHTML += message + '<hr>';
            console.log(`[Test] ${testName}: ${passed ? 'PASS' : 'FAIL'}`, { expected, actual });
        }

        function testUobPpvContactless() {
            const ppvResults = document.getElementById('ppv-results');
            ppvResults.innerHTML = '<strong>Running UOB PPV Contactless Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 27.50, mcc_code: '5411' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 43.20, mcc_code: '5811' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 12.80, mcc_code: '5999' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            const expected = { contactless: 80, online: 0 }; // 25 + 40 + 10 = 75, but wait let me recalculate: floor(27.5/5)*5 = 25, floor(43.2/5)*5 = 40, floor(12.8/5)*5 = 10 = 75
            // Actually: 25 + 40 + 10 = 75
            const expectedCorrect = { contactless: 75, online: 0 };
            const passed = result.contactless === expectedCorrect.contactless && result.online === expectedCorrect.online;
            
            displayResult('ppv-results', 'UOB PPV Contactless Bucket', passed, expectedCorrect, result);
        }

        function testUobPpvOnline() {
            const ppvResults = document.getElementById('ppv-results');
            ppvResults.innerHTML += '<strong>Running UOB PPV Online Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'online', base_currency_amount: 52.30, mcc_code: '5611' } }, // Shopping MCC
                { transaction: { payment_tag: 'online', base_currency_amount: 38.90, mcc_code: '5811' } }, // Dining MCC
                { transaction: { payment_tag: 'online', base_currency_amount: 25.60, mcc_code: '7999' } }, // Entertainment MCC
                { transaction: { payment_tag: 'online', base_currency_amount: 19.40, mcc_code: '9999' } }  // Not in eligible MCC list
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            // 50 + 35 + 25 = 110 (19.40 with MCC 9999 is not eligible)
            const expected = { contactless: 0, online: 110 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('ppv-results', 'UOB PPV Online Bucket', passed, expected, result);
        }

        function testUobPpvMixed() {
            const ppvResults = document.getElementById('ppv-results');
            ppvResults.innerHTML += '<strong>Running UOB PPV Mixed Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 33.70, mcc_code: '5411' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 47.20, mcc_code: '5812' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 18.50, mcc_code: '5999' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 62.80, mcc_code: '5621' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB PPV');
            // Contactless: 30 + 15 = 45
            // Online: 45 + 60 = 105
            const expected = { contactless: 45, online: 105 };
            const passed = result.contactless === expected.contactless && result.online === expected.online;
            
            displayResult('ppv-results', 'UOB PPV Mixed Buckets', passed, expected, result);
        }

        function testUobVsContactless() {
            const vsResults = document.getElementById('vs-results');
            vsResults.innerHTML = '<strong>Running UOB VS Contactless Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 27.50, original_currency: 'SGD' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 43.20, original_currency: 'SGD' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 12.80, original_currency: 'SGD' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB VS');
            // Contactless: 25 + 40 + 10 = 75
            // Foreign: 0 (all SGD)
            const expected = { contactless: 75, foreignCurrency: 0 };
            const passed = result.contactless === expected.contactless && result.foreignCurrency === expected.foreignCurrency;
            
            displayResult('vs-results', 'UOB VS Contactless Bucket', passed, expected, result);
        }

        function testUobVsForeignCurrency() {
            const vsResults = document.getElementById('vs-results');
            vsResults.innerHTML += '<strong>Running UOB VS Foreign Currency Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'online', base_currency_amount: 52.30, original_currency: 'USD' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 38.90, original_currency: 'EUR' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 25.60, original_currency: 'GBP' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 19.40, original_currency: 'SGD' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB VS');
            // Contactless: 0 (no contactless)
            // Foreign: 50 + 35 + 25 = 110 (SGD transaction not counted)
            const expected = { contactless: 0, foreignCurrency: 110 };
            const passed = result.contactless === expected.contactless && result.foreignCurrency === expected.foreignCurrency;
            
            displayResult('vs-results', 'UOB VS Foreign Currency Bucket', passed, expected, result);
        }

        function testUobVsMixed() {
            const vsResults = document.getElementById('vs-results');
            vsResults.innerHTML += '<strong>Running UOB VS Mixed Test...</strong><br>';
            
            const transactions = [
                { transaction: { payment_tag: 'contactless', base_currency_amount: 33.70, original_currency: 'SGD' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 47.20, original_currency: 'USD' } },
                { transaction: { payment_tag: 'contactless', base_currency_amount: 18.50, original_currency: 'EUR' } },
                { transaction: { payment_tag: 'online', base_currency_amount: 62.80, original_currency: 'SGD' } }
            ];
            
            const result = calculateBuckets(transactions, 'UOB VS');
            // Contactless: 30 + 15 = 45 (both contactless transactions count)
            // Foreign: 45 + 15 = 60 (USD online + EUR contactless, SGD transactions don't count)
            const expected = { contactless: 45, foreignCurrency: 60 };
            const passed = result.contactless === expected.contactless && result.foreignCurrency === expected.foreignCurrency;
            
            displayResult('vs-results', 'UOB VS Mixed Buckets', passed, expected, result);
        }

        // Initial message
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Test Page] Calculate Buckets test page loaded');
            console.log('[Test Page] Click test buttons to run tests');
        });
    </script>
</body>
</html>
